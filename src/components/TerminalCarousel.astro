---
import AnimatedTerminal from './AnimatedTerminal.astro';

const terminals = [
  {
    id: 'status',
    title: 'rtmx status',
    command: 'rtmx status',
    caption: 'See your progress at a glance.',
    lines: [
      { text: '=============================== RTM Status Check ===============================', color: '#6b7280' },
      { text: 'Requirements:                                                                 74.0%', color: '#e5e7eb' },
      { segments: [
        { text: '  [', color: '#e5e7eb' },
        { text: '████████████████████████████████████████████████████████', color: '#22c55e' },
        { text: '████████████████████', color: '#ef4444' },
        { text: ']', color: '#e5e7eb' }
      ]},
      { text: '  ✓ 54 COMPLETE  △ 0 PARTIAL  ✗ 19 MISSING  (73 total)', color: '#9ca3af' },
      { text: '================================= Phase Status =================================', color: '#6b7280' },
      { text: 'Phase 1 (Foundation):    100.0%  ✓ Complete     (8✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 2 (Core Features): 100.0%  ✓ Complete     (6✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 3 (Testing):       100.0%  ✓ Complete     (3✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 4 (Developer Exp): 100.0%  ✓ Complete    (11✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 5 (CLI UX):        100.0%  ✓ Complete     (7✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 6 (Web UI):        100.0%  ✓ Complete     (8✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 7 (Real-Time):     100.0%  ✓ Complete     (6✓ 0⚠ 0✗)', color: '#22c55e' },
      { text: 'Phase 8 (Website):        83.3%  ⚠ In Progress  (5✓ 0⚠ 1✗)', color: '#eab308' },
      { text: 'Phase 9 (CRDT):            0.0%  ✗ Not Started  (0✓ 0⚠ 6✗)', color: '#ef4444' },
      { text: 'Phase 10 (Collaboration):  0.0%  ✗ Not Started  (0✓ 0⚠ 6✗)', color: '#ef4444' },
      { text: 'Phase 11 (IDE):            0.0%  ✗ Not Started  (0✓ 0⚠ 5✗)', color: '#ef4444' },
      { text: 'Phase 12 (Distribution):   0.0%  ✗ Not Started  (0✓ 0⚠ 1✗)', color: '#ef4444' },
      { text: '==================== 54 complete, 0 partial, 19 missing (74.0%) ====================', color: '#22c55e' },
    ]
  },
  {
    id: 'backlog',
    title: 'rtmx backlog',
    command: 'rtmx backlog',
    caption: 'Know exactly what to build next.',
    lines: [
      { text: '============================= Prioritized Backlog =============================', color: '#6b7280' },
      { text: 'Total Requirements: 73', color: '#e5e7eb' },
      { text: '  ✗ MISSING: 19 (26.0%)', color: '#ef4444' },
      { text: '  △ PARTIAL: 0 (0.0%)', color: '#eab308' },
      { text: 'Estimated Effort: 35.0 weeks', color: '#6b7280' },
      { text: 'CRITICAL PATH ITEMS (TOP 10)', color: '#e5e7eb' },
      { text: '+-----+----------+----------------+--------------------------------------+----------+----------+', color: '#6b7280' },
      { text: '|   # | Status   | Requirement    | Description                          | Effort   | Blocks   |', color: '#9ca3af' },
      { text: '+=====+==========+================+======================================+==========+==========+', color: '#6b7280' },
      { text: '|   1 | ✗        | REQ-CRDT-001   | CRDT layer shall use y-py library    | 1.0w     | 11 (0)   |', color: '#ef4444' },
      { text: '+-----+----------+----------------+--------------------------------------+----------+----------+', color: '#6b7280' },
      { text: '|   2 | ✗        | REQ-COLLAB-001 | CRDT sync server shall use y-web...  | 2.0w     | 5 (0)    |', color: '#ef4444' },
      { text: '+-----+----------+----------------+--------------------------------------+----------+----------+', color: '#6b7280' },
      { text: '|   3 | ✗        | REQ-COLLAB-002 | Server shall track connected use...  | 1.5w     | 3 (0)    |', color: '#ef4444' },
      { text: '+-----+----------+----------------+--------------------------------------+----------+----------+', color: '#6b7280' },
      { text: '|   4 | ✗        | REQ-CRDT-002   | Requirements shall be represente...  | 2.0w     | 2 (0)    |', color: '#ef4444' },
      { text: '+-----+----------+----------------+--------------------------------------+----------+----------+', color: '#6b7280' },
      { text: '|   5 | ✗        | REQ-IDE-001    | VSCode extension shall display R...  | 3.0w     | 2 (0)    |', color: '#ef4444' },
      { text: '+-----+----------+----------------+--------------------------------------+----------+----------+', color: '#6b7280' },
    ]
  },
  {
    id: 'health',
    title: 'rtmx health',
    command: 'rtmx health',
    caption: 'Catch issues before they become problems.',
    lines: [
      { text: '============================== RTMX Health Check ==============================', color: '#6b7280' },
      { text: '  [PASS] config_valid: Config valid: rtmx.yaml', color: '#22c55e' },
      { text: '  [PASS] rtm_exists: RTM database found: docs/rtm_database.csv', color: '#22c55e' },
      { text: '  [PASS] rtm_loads: RTM database loaded: 73 requirements', color: '#22c55e' },
      { text: '  [PASS] schema_valid: Schema validation passed', color: '#22c55e' },
      { text: '  [WARN] reciprocity: Reciprocity violations: 53', color: '#eab308' },
      { text: '  [PASS] cycles: No circular dependencies', color: '#22c55e' },
      { text: '  [WARN] test_markers: Test coverage: 46.6% (39 requirements without tests)', color: '#eab308' },
      { text: '  [WARN] agent_configs: Agent configs without RTMX: CLAUDE.md', color: '#eab308' },
      { text: '============================================================', color: '#6b7280' },
      { text: 'Status: DEGRADED (warnings present)', color: '#eab308' },
      { text: 'Summary: 5 passed, 3 warnings, 0 failed, 0 skipped', color: '#e5e7eb' },
    ]
  },
  {
    id: 'deps',
    title: 'rtmx deps',
    command: 'rtmx deps',
    caption: 'Find what\'s blocking your progress.',
    lines: [
      { text: '================================= Dependencies =================================', color: '#6b7280' },
      { text: 'ID                 Deps   Blocks   Description', color: '#9ca3af' },
      { text: '-------------------------------------------------------------------------------------', color: '#6b7280' },
      { text: 'REQ-WEB-001        0      23       rtmx serve command shall start FastAPI...', color: '#e5e7eb' },
      { text: 'REQ-WEB-007        1      12       Server shall support WebSocket connections', color: '#e5e7eb' },
      { text: 'REQ-CRDT-001       0      11       CRDT layer shall use y-py library', color: '#ef4444' },
      { text: 'REQ-WEB-002        1      8        REST API shall expose /api/status endpoint', color: '#e5e7eb' },
      { text: 'REQ-RT-001         1      6        Server shall watch RTM database for changes', color: '#e5e7eb' },
      { text: 'REQ-UX-001         0      5        rtmx status shall display rich progress bars', color: '#e5e7eb' },
      { text: 'REQ-RT-002         1      5        Server shall push updates to WebSocket...', color: '#e5e7eb' },
      { text: 'REQ-SITE-001       0      5        Website shall use Astro with Starlight theme', color: '#e5e7eb' },
      { text: 'REQ-COLLAB-001     2      5        CRDT sync server shall use y-websocket...', color: '#ef4444' },
      { text: 'REQ-DX-001         0      4        All rtmx artifacts shall be in .rtmx/...', color: '#e5e7eb' },
      { text: '-------------------------------------------------------------------------------------', color: '#6b7280' },
      { text: '✓ No circular dependencies detected', color: '#22c55e' },
    ]
  }
];
---

<section class="carousel-section">
  <h2>See It In Action</h2>

  <div class="carousel-container">
    <button class="carousel-nav prev" aria-label="Previous">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 19l-7-7 7-7"/>
      </svg>
    </button>

    <div class="carousel-track">
      {terminals.map((term, index) => (
        <div class="carousel-slide" data-index={index}>
          <AnimatedTerminal
            id={term.id}
            title={term.title}
            command={term.command}
            lines={term.lines}
          />
          <p class="slide-caption">{term.caption}</p>
        </div>
      ))}
    </div>

    <button class="carousel-nav next" aria-label="Next">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 5l7 7-7 7"/>
      </svg>
    </button>
  </div>

  <div class="carousel-dots">
    {terminals.map((term, index) => (
      <button
        class={`dot ${index === 0 ? 'active' : ''}`}
        data-index={index}
        aria-label={`Go to ${term.title}`}
      />
    ))}
  </div>
</section>

<style is:global>
  .carousel-section {
    padding: 5rem 2rem;
    background: #0a0a0a;
  }

  .carousel-section h2 {
    color: #f9fafb;
    text-align: center;
    margin-bottom: 3rem;
    font-size: 2.25rem;
  }

  .carousel-container {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    max-width: 1000px;
    margin: 0 auto;
  }

  .carousel-nav {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #171717;
    border: 1px solid #262626;
    color: #9ca3af;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .carousel-nav:hover {
    background: #262626;
    color: #10b981;
    border-color: #10b981;
  }

  .carousel-nav svg {
    width: 24px;
    height: 24px;
  }

  .carousel-track {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  .carousel-slide {
    display: none;
    animation: fadeIn 0.4s ease;
  }

  .carousel-slide.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.98); }
    to { opacity: 1; transform: scale(1); }
  }

  .slide-caption {
    text-align: center;
    color: #10b981;
    margin-top: 1.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-top: 1.5rem;
  }

  .dot {
    width: 10px;
    height: 10px;
    min-width: 10px;
    min-height: 10px;
    border-radius: 50%;
    background: #404040;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    transition: background 0.2s ease;
    appearance: none;
    -webkit-appearance: none;
    outline: none;
    vertical-align: middle;
    display: inline-block;
    box-sizing: border-box;
  }

  .dot:hover {
    background: #6b7280;
  }

  .dot.active {
    background: #10b981;
  }

  @media (max-width: 768px) {
    .carousel-nav {
      display: none;
    }

    .carousel-section {
      padding: 3rem 1rem;
    }

    .carousel-section h2 {
      font-size: 1.75rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const slides = document.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll('.carousel-dots .dot');
    const prevBtn = document.querySelector('.carousel-nav.prev');
    const nextBtn = document.querySelector('.carousel-nav.next');

    let currentIndex = 0;
    let autoplayInterval;

    function showSlide(index) {
      // Wrap around
      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;

      currentIndex = index;

      // Update slides
      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === currentIndex);
      });

      // Update dots
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });

      // Trigger animation restart for the active terminal
      const activeTerminal = slides[currentIndex].querySelector('.animated-terminal');
      if (activeTerminal) {
        activeTerminal.dispatchEvent(new Event('restart'));
      }
    }

    function nextSlide() {
      showSlide(currentIndex + 1);
    }

    function prevSlide() {
      showSlide(currentIndex - 1);
    }

    // Event listeners
    prevBtn?.addEventListener('click', () => {
      prevSlide();
      resetAutoplay();
    });

    nextBtn?.addEventListener('click', () => {
      nextSlide();
      resetAutoplay();
    });

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showSlide(index);
        resetAutoplay();
      });
    });

    // Autoplay
    function startAutoplay() {
      autoplayInterval = setInterval(nextSlide, 12000);
    }

    function resetAutoplay() {
      clearInterval(autoplayInterval);
      startAutoplay();
    }

    // Touch/swipe support
    let touchStartX = 0;
    const track = document.querySelector('.carousel-track');

    track?.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    });

    track?.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) nextSlide();
        else prevSlide();
        resetAutoplay();
      }
    });

    // Initialize
    showSlide(0);
    startAutoplay();
  });
</script>
